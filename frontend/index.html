<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notificator · Inscription</title>
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        --bg: radial-gradient(circle at 15% 20%, rgba(59, 130, 246, 0.16), transparent 30%),
          radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.16), transparent 28%),
          #060910;
        --panel: #0e1524;
        --border: #1f2937;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --accent: #22d3ee;
        --positive: #34d399;
        color-scheme: dark;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        overflow-x: hidden;
      }

      .page {
        width: min(960px, calc(100vw - 32px));
        margin: 0 auto;
        padding: clamp(32px, 4vw, 48px) clamp(18px, 3vw, 22px) 96px;
        display: grid;
        gap: 16px;
      }

      header {
        display: grid;
        gap: 10px;
        margin-bottom: 10px;
      }

      .eyebrow {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--border);
        color: var(--muted);
        width: fit-content;
        font-size: 14px;
      }

      h1 {
        margin: 0;
        font-size: clamp(28px, 4vw, 38px);
      }

      header p { margin: 0; color: var(--muted); max-width: 760px; }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 16px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 22px;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.18);
      }

      .panel h2 { margin: 0 0 8px; }
      .panel p { margin: 0 0 12px; color: var(--muted); }

      .affiliation-card {
        display: grid;
        gap: 10px;
        padding: 14px;
        border-radius: 14px;
        border: 1px dashed var(--border);
        background: rgba(34, 211, 238, 0.06);
        margin-bottom: 6px;
      }

      .affiliation-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      label { display: block; margin: 12px 0 6px; font-weight: 600; }

      input, button {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #0a0f1a;
        color: var(--text);
        font-size: 16px;
        box-sizing: border-box;
      }

      button {
        background: linear-gradient(135deg, #22d3ee, #0ea5e9);
        border: none;
        margin-top: 14px;
        cursor: pointer;
        font-weight: 800;
        letter-spacing: 0.2px;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }

      button.ghost {
        background: #0a0f1a;
        color: var(--muted);
        border: 1px solid var(--border);
      }

      .affiliation-actions button {
        width: auto;
        min-width: 120px;
        margin-top: 0;
      }

      button:hover { transform: translateY(-1px); box-shadow: 0 12px 28px rgba(14, 165, 233, 0.35); }

      .status { color: var(--positive); font-weight: 600; margin-top: 8px; }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(34, 211, 238, 0.1);
        color: #67e8f9;
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-weight: 700;
      }

      .steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin-top: 14px;
      }

      .step {
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #0a0f1a;
      }

      .callout {
        display: grid;
        gap: 8px;
        border-radius: 14px;
        border: 1px dashed var(--border);
        padding: 14px;
        background: rgba(255, 255, 255, 0.04);
      }

      .notification-banner {
        position: fixed;
        bottom: 16px;
        right: 16px;
        left: 16px;
        max-width: 520px;
        margin: 0 auto;
        background: #0e1524;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        display: none;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
      }

      .notification-banner h3 { margin: 0 0 8px; }
      .notification-banner button { width: auto; margin-top: 0; }

      @media (max-width: 640px) {
        .page { padding: 36px 18px 80px; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div class="eyebrow">Inscription Web Push</div>
        <h1>Activez les alertes Notificator</h1>
        <p>
          Une fois les notifications autorisées, le service worker diffusera les messages même si l'onglet est fermé.
          Les informations commerciales saisies sont liées automatiquement au commerce ciblé.
        </p>
      </header>

      <div class="layout">
        <section class="panel">
          <h2>Votre session</h2>
          <p id="enrollment-info" class="status"></p>
          <div id="affiliation-card" class="affiliation-card" style="display:none;">
            <div id="affiliation-question" class="status" style="margin:0;">Accepter les notifications de votre commerçant ?</div>
            <p id="affiliation-description" style="margin:0;"></p>
            <div class="affiliation-actions">
              <button type="button" id="accept-affiliation">Oui, activer</button>
              <button type="button" class="ghost" id="decline-affiliation">Non</button>
            </div>
            <small id="affiliation-memory" style="color: var(--muted);">
              Nous mémoriserons votre accord pour ne plus vous le redemander sur cette page.
            </small>
          </div>
          <form id="subscribe-form">
            <label for="label">Nom du commerce (facultatif)</label>
            <input id="label" type="text" placeholder="Boulangerie des Halles" />
            <button type="submit">Activer les notifications Web Push</button>
          </form>
          <p id="subscription-status" class="status"></p>
          <div id="device-token" class="badge" style="display:none;"></div>
        </section>

        <section class="panel">
          <h2>Comment ça marche ?</h2>
          <p>Quelques étapes pour vérifier que la configuration est correcte.</p>
          <div class="steps">
            <div class="step">
              <strong>1. Autorisation</strong>
              <p class="status" style="color: var(--muted);">Acceptez la demande de notification du navigateur.</p>
            </div>
            <div class="step">
              <strong>2. Enrôlement</strong>
              <p class="status" style="color: var(--muted);">Le service worker enregistre l'abonnement Web Push.</p>
            </div>
            <div class="step">
              <strong>3. Liaison commerce</strong>
              <p class="status" style="color: var(--muted);">Le commerce est associé via le lien d'inscription partagé.</p>
            </div>
          </div>
          <div class="callout">
            <strong>Conseil</strong>
            <span>Sur mobile, vérifiez aussi les autorisations de notifications système pour votre navigateur.</span>
          </div>
        </section>
      </div>
    </div>

    <div class="notification-banner" id="banner" role="status" aria-live="polite">
      <h3>Notifications prêtes</h3>
      <p id="banner-text" style="color: var(--muted); margin: 0 0 12px;"></p>
      <button type="button" id="banner-close">Fermer</button>
    </div>

    <script>
      const statusEl = document.getElementById('subscription-status');
      const tokenBadge = document.getElementById('device-token');
      const labelInput = document.getElementById('label');
      const enrollmentInfo = document.getElementById('enrollment-info');
      const banner = document.getElementById('banner');
      const bannerText = document.getElementById('banner-text');
      const bannerClose = document.getElementById('banner-close');
      const affiliationCard = document.getElementById('affiliation-card');
      const affiliationQuestion = document.getElementById('affiliation-question');
      const affiliationDescription = document.getElementById('affiliation-description');
      const affiliationMemory = document.getElementById('affiliation-memory');
      const acceptAffiliationBtn = document.getElementById('accept-affiliation');
      const declineAffiliationBtn = document.getElementById('decline-affiliation');

      const ACCEPTED_BUSINESSES_KEY = 'notificator-accepted-businesses';
      const ACCEPTED_PAGES_KEY = 'notificator-accepted-pages';
      const LAST_BUSINESS_KEY = 'notificator-last-business';
      const currentPageKey = `${window.location.pathname}${window.location.search}`;

      const urlParams = new URLSearchParams(window.location.search);
      const rawBusinessId = urlParams.get('business_id');
      const resolvedBusinessId =
        rawBusinessId !== null && rawBusinessId !== '' && Number.isFinite(Number(rawBusinessId))
          ? Number(rawBusinessId)
          : null;
      const businessName = urlParams.get('business_name');

      function readStoredJson(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch (error) {
          console.error('Impossible de lire le stockage local', error);
          return fallback;
        }
      }

      function writeStoredJson(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }

      function rememberAcceptedPage(pageKey) {
        const pages = readStoredJson(ACCEPTED_PAGES_KEY, []);
        if (!pages.includes(pageKey)) {
          pages.push(pageKey);
          writeStoredJson(ACCEPTED_PAGES_KEY, pages);
        }
      }

      function hasAcceptedPage(pageKey) {
        const pages = readStoredJson(ACCEPTED_PAGES_KEY, []);
        return pages.includes(pageKey);
      }

      function rememberAcceptedBusiness(businessId, name) {
        if (!businessId) return;
        const stored = readStoredJson(ACCEPTED_BUSINESSES_KEY, []);
        const filtered = stored.filter((entry) => entry.businessId !== businessId);
        filtered.push({ businessId, name, updatedAt: new Date().toISOString() });
        writeStoredJson(ACCEPTED_BUSINESSES_KEY, filtered);
      }

      function hasAcceptedBusiness(businessId) {
        if (!businessId) return false;
        const stored = readStoredJson(ACCEPTED_BUSINESSES_KEY, []);
        return stored.some((entry) => entry.businessId === businessId);
      }

      function rememberLastBusiness(businessId, name) {
        if (!businessId && !name) return;
        writeStoredJson(LAST_BUSINESS_KEY, { businessId, name });
      }

      function markAffiliationAccepted(displayName) {
        if (!affiliationCard) return;
        affiliationCard.style.display = 'grid';
        affiliationCard.classList.add('accepted');
        affiliationQuestion.textContent = `Notifications déjà activées pour ${displayName}`;
        affiliationDescription.textContent =
          'Nous avons mémorisé votre accord pour ce commerce sur cet appareil.';
        affiliationMemory.textContent =
          'Vous pouvez relancer une activation manuelle depuis le formulaire si nécessaire.';
        if (acceptAffiliationBtn) {
          acceptAffiliationBtn.textContent = 'Déjà activé';
          acceptAffiliationBtn.disabled = true;
        }
      }

      function hydrateAffiliationCard() {
        if (!affiliationCard) return;
        const displayName = businessName || 'votre commerçant';
        const alreadyAccepted =
          resolvedBusinessId && (hasAcceptedBusiness(resolvedBusinessId) || hasAcceptedPage(currentPageKey));

        if (!resolvedBusinessId) {
          affiliationCard.style.display = 'none';
          return;
        }

        affiliationCard.style.display = 'grid';
        affiliationQuestion.textContent = 'Accepter les notifications de votre commerçant ?';
        affiliationDescription.textContent =
          `Vous êtes invité à recevoir les notifications de ${displayName}. Dites « Oui » pour continuer.`;
        affiliationMemory.textContent =
          'Une fois accepté, le navigateur retiendra ce commerce et ne vous reposera plus la question.';

        if (alreadyAccepted) {
          markAffiliationAccepted(displayName);
          statusEl.textContent = 'Notifications déjà autorisées pour ce commerce sur cet appareil.';
          statusEl.style.color = '#34d399';
        }
      }

      if (resolvedBusinessId) {
        const displayName = businessName || 'ce commerce';
        enrollmentInfo.textContent = `Vous allez lier cette inscription au commerce « ${displayName} » (ID ${resolvedBusinessId}). Nous mémoriserons votre choix sur cet appareil.`;
        if (businessName) {
          labelInput.value = businessName;
        }
      }

      hydrateAffiliationCard();

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function registerPush() {
        if (!('serviceWorker' in navigator)) {
          throw new Error('Service worker non supporté par ce navigateur.');
        }

        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          throw new Error('Les notifications ont été refusées.');
        }

        const registration = await navigator.serviceWorker.register('/sw.js');
        const configResponse = await fetch('/api/config');
        if (!configResponse.ok) {
          throw new Error('Impossible de récupérer la clé publique VAPID.');
        }
        const { public_key: publicKey } = await configResponse.json();

        const existing = await registration.pushManager.getSubscription();
        const sub =
          existing ||
          (await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          }));

        const body = {
          subscription: sub.toJSON(),
          label: labelInput.value || null,
          user_agent: navigator.userAgent,
          business_id: resolvedBusinessId,
        };

        const response = await fetch('/api/subscribers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          throw new Error("Impossible d'enregistrer l'abonnement côté serveur.");
        }

        const data = await response.json();
        localStorage.setItem('deviceToken', data.device_token);
        tokenBadge.textContent = `Token : ${data.device_token}`;
        tokenBadge.style.display = 'inline-flex';
        bannerText.textContent = 'Votre navigateur est maintenant inscrit et prêt à recevoir les alertes Notificator.';
        banner.style.display = 'block';

        return data;
      }

      async function performSubscriptionFlow() {
        statusEl.textContent = 'Activation en cours...';
        statusEl.style.color = '#34d399';
        try {
          const data = await registerPush();
          const displayName = businessName || labelInput.value || 'votre commerçant';
          if (resolvedBusinessId) {
            rememberAcceptedBusiness(resolvedBusinessId, displayName);
            rememberLastBusiness(resolvedBusinessId, displayName);
          }
          rememberAcceptedPage(currentPageKey);
          markAffiliationAccepted(displayName);

          const message = resolvedBusinessId
            ? `Inscription Web Push confirmée pour le commerce (ID ${resolvedBusinessId}). Vous pouvez fermer la page.`
            : 'Inscription Web Push confirmée. Vous pouvez fermer la page.';
          statusEl.textContent = message;
          return data;
        } catch (error) {
          console.error(error);
          statusEl.textContent = error.message;
          statusEl.style.color = '#f87171';
          throw error;
        }
      }

      const subscribeForm = document.getElementById('subscribe-form');
      subscribeForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        await performSubscriptionFlow();
      });

      if (acceptAffiliationBtn) {
        acceptAffiliationBtn.addEventListener('click', () => performSubscriptionFlow());
      }

      if (declineAffiliationBtn) {
        declineAffiliationBtn.addEventListener('click', () => {
          statusEl.textContent = 'Vous pourrez activer les notifications plus tard depuis cette même page.';
          statusEl.style.color = '#9ca3af';
          if (affiliationCard) {
            affiliationCard.classList.add('declined');
          }
        });
      }

      const existingToken = localStorage.getItem('deviceToken');
      if (existingToken) {
        tokenBadge.textContent = `Token : ${existingToken}`;
        tokenBadge.style.display = 'inline-flex';
        statusEl.textContent = 'Session Web Push déjà active.';
        if (resolvedBusinessId) {
          const displayName = businessName || labelInput.value || 'votre commerçant';
          rememberAcceptedBusiness(resolvedBusinessId, displayName);
          rememberAcceptedPage(currentPageKey);
          rememberLastBusiness(resolvedBusinessId, displayName);
          markAffiliationAccepted(displayName);
        }
      }

      bannerClose.addEventListener('click', () => {
        banner.style.display = 'none';
      });
    </script>
  </body>
</html>
