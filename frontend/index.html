<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notificator · Enrôlement</title>
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        --bg: radial-gradient(circle at 15% 20%, rgba(34, 211, 238, 0.12), transparent 28%),
          radial-gradient(circle at 80% 0%, rgba(59, 130, 246, 0.12), transparent 30%),
          #060910;
        --panel: #0e1524;
        --border: #1f2937;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #22d3ee;
        --positive: #34d399;
        color-scheme: dark;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        background: var(--bg);
        color: var(--text);
        padding: 24px;
      }

      .card {
        width: min(520px, 100%);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: clamp(22px, 4vw, 32px);
        display: grid;
        gap: 18px;
        text-align: center;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.18);
      }

      .eyebrow {
        margin: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--muted);
        width: fit-content;
        justify-self: center;
      }

      h1 {
        margin: 0;
        font-size: clamp(24px, 4vw, 32px);
      }

      .actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 18px;
        border-radius: 12px;
        border: none;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        min-width: 140px;
        background: linear-gradient(135deg, #22d3ee, #0ea5e9);
        color: #0b1220;
        letter-spacing: 0.2px;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }

      button:hover { transform: translateY(-1px); box-shadow: 0 12px 28px rgba(14, 165, 233, 0.35); }
      button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }

      button.ghost {
        background: #0a0f1a;
        color: var(--muted);
        border: 1px solid var(--border);
      }

      .status {
        margin: 0;
        color: var(--muted);
        line-height: 1.5;
        min-height: 20px;
      }

      .status.positive { color: var(--positive); }
      .status.negative { color: #f87171; }
    </style>
  </head>
  <body>
    <main class="card">
      <p id="business-label" class="eyebrow" style="display:none;"></p>
      <h1 id="prompt-text">Activer les alertes de votre commerçant ?</h1>
      <div class="actions">
        <button id="accept-btn" type="button">Oui</button>
        <button id="decline-btn" class="ghost" type="button">Non</button>
      </div>
      <p id="status" class="status" aria-live="polite"></p>
    </main>

    <script>
      const promptText = document.getElementById('prompt-text');
      const businessLabel = document.getElementById('business-label');
      const statusEl = document.getElementById('status');
      const acceptBtn = document.getElementById('accept-btn');
      const declineBtn = document.getElementById('decline-btn');

      const ACCEPTED_BUSINESSES_KEY = 'notificator-accepted-businesses';
      const ACCEPTED_PAGES_KEY = 'notificator-accepted-pages';
      const LAST_BUSINESS_KEY = 'notificator-last-business';
      const currentPageKey = `${window.location.pathname}${window.location.search}`;
      let redirectInProgress = false;

      const urlParams = new URLSearchParams(window.location.search);
      const rawBusinessId = urlParams.get('business_id');
      const resolvedBusinessId =
        rawBusinessId !== null && rawBusinessId !== '' && Number.isFinite(Number(rawBusinessId))
          ? Number(rawBusinessId)
          : null;
      const businessName = urlParams.get('business_name');
      const DEFAULT_PROMPT = 'Activer les alertes de votre commerçant ?';

      function readStoredJson(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch (error) {
          console.error('Impossible de lire le stockage local', error);
          return fallback;
        }
      }

      function writeStoredJson(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }

      function rememberAcceptedPage(pageKey) {
        const pages = readStoredJson(ACCEPTED_PAGES_KEY, []);
        if (!pages.includes(pageKey)) {
          pages.push(pageKey);
          writeStoredJson(ACCEPTED_PAGES_KEY, pages);
        }
      }

      function hasAcceptedPage(pageKey) {
        const pages = readStoredJson(ACCEPTED_PAGES_KEY, []);
        return pages.includes(pageKey);
      }

      function rememberAcceptedBusiness(businessId, name) {
        if (!businessId) return;
        const stored = readStoredJson(ACCEPTED_BUSINESSES_KEY, []);
        const filtered = stored.filter((entry) => entry.businessId !== businessId);
        filtered.push({ businessId, name, updatedAt: new Date().toISOString() });
        writeStoredJson(ACCEPTED_BUSINESSES_KEY, filtered);
      }

      function hasAcceptedBusiness(businessId) {
        if (!businessId) return false;
        const stored = readStoredJson(ACCEPTED_BUSINESSES_KEY, []);
        return stored.some((entry) => entry.businessId === businessId);
      }

      function rememberLastBusiness(businessId, name) {
        if (!businessId && !name) return;
        writeStoredJson(LAST_BUSINESS_KEY, { businessId, name });
      }

      function setStatus(message, tone = 'muted') {
        statusEl.textContent = message || '';
        statusEl.classList.remove('positive', 'negative');
        if (tone === 'positive') statusEl.classList.add('positive');
        if (tone === 'negative') statusEl.classList.add('negative');
      }

      function resolveNotificationUrl(notification) {
        if (!notification) return null;
        if (notification.click_url) return notification.click_url;

        const params = new URLSearchParams();
        if (notification.image_url) params.set('image', notification.image_url);
        if (notification.title) params.set('title', notification.title);
        if (notification.body) params.set('body', notification.body);

        const query = params.toString();
        return query ? `/notification.html?${query}` : '/notification.html';
      }

      async function redirectToLatestNotification(businessId, displayName) {
        if (!businessId || redirectInProgress) return;
        redirectInProgress = true;

        try {
          setStatus(
            `Notifications déjà activées pour ${displayName}. Redirection vers la dernière alerte...`,
            'positive'
          );
          const response = await fetch(`/api/businesses/${businessId}/notifications/latest`);
          if (!response.ok) {
            return;
          }

          const notification = await response.json();
          const targetUrl = resolveNotificationUrl(notification);
          if (targetUrl) {
            window.location.href = targetUrl;
          }
        } catch (error) {
          console.error('Impossible de récupérer la dernière notification', error);
        }
      }

      async function loadPrompt() {
        try {
          const response = await fetch('/api/settings/enrollment_prompt');
          if (!response.ok) throw new Error('fallback');
          const data = await response.json();
          promptText.textContent = data.value || DEFAULT_PROMPT;
        } catch (error) {
          promptText.textContent = DEFAULT_PROMPT;
        }
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function registerPush() {
        if (!('serviceWorker' in navigator)) {
          throw new Error('Service worker non supporté par ce navigateur.');
        }

        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          throw new Error('Les notifications ont été refusées.');
        }

        const registration = await navigator.serviceWorker.register('/sw.js');
        const configResponse = await fetch('/api/config');
        if (!configResponse.ok) {
          throw new Error('Impossible de récupérer la clé publique VAPID.');
        }
        const { public_key: publicKey } = await configResponse.json();

        const existing = await registration.pushManager.getSubscription();
        const sub =
          existing ||
          (await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          }));

        const body = {
          subscription: sub.toJSON(),
          label: businessName || null,
          user_agent: navigator.userAgent,
          business_id: resolvedBusinessId,
        };

        const response = await fetch('/api/subscribers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          throw new Error("Impossible d'enregistrer l'abonnement côté serveur.");
        }

        const data = await response.json();
        localStorage.setItem('deviceToken', data.device_token);
        return data;
      }

      function markAccepted(displayName) {
        acceptBtn.disabled = true;
        setStatus(`Notifications déjà activées pour ${displayName}.`, 'positive');
      }

      async function performSubscriptionFlow() {
        setStatus('Activation en cours...', 'positive');
        try {
          const data = await registerPush();
          const displayName = businessName || 'votre commerçant';
          if (resolvedBusinessId) {
            rememberAcceptedBusiness(resolvedBusinessId, displayName);
            rememberLastBusiness(resolvedBusinessId, displayName);
          }
          rememberAcceptedPage(currentPageKey);
          markAccepted(displayName);
          return data;
        } catch (error) {
          console.error(error);
          setStatus(error.message, 'negative');
          throw error;
        }
      }

      function hydrateBusinessBadge() {
        if (!businessName && !resolvedBusinessId) return;
        const labelParts = [];
        if (businessName) labelParts.push(businessName);
        if (resolvedBusinessId) labelParts.push(`ID ${resolvedBusinessId}`);
        businessLabel.textContent = labelParts.join(' · ');
        businessLabel.style.display = 'inline-flex';
      }

      async function hydrateAcceptance() {
        const pageAccepted = hasAcceptedPage(currentPageKey);
        if (resolvedBusinessId) {
          if (hasAcceptedBusiness(resolvedBusinessId) || pageAccepted) {
            const displayName = businessName || 'votre commerçant';
            markAccepted(displayName);
            await redirectToLatestNotification(resolvedBusinessId, displayName);
          }
          return;
        }

        if (pageAccepted) {
          markAccepted('Notificator');
        }
      }

      acceptBtn.addEventListener('click', () => performSubscriptionFlow());
      declineBtn.addEventListener('click', () => {
        setStatus('Redirection vers Google...', 'muted');
        window.location.href = 'https://www.google.com';
      });

      (async function init() {
        hydrateBusinessBadge();
        await loadPrompt();
        await hydrateAcceptance();
      })();
    </script>
  </body>
</html>
