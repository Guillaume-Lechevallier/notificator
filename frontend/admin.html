<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notificator ¬∑ Administration</title>
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        --bg: radial-gradient(circle at 10% 20%, rgba(67, 56, 202, 0.12), transparent 30%),
          radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.12), transparent 28%),
          #05070f;
        --panel: #0c1220;
        --panel-border: #1e2638;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --accent: #f59e0b;
        --positive: #34d399;
        --negative: #f87171;
        --surface: #0f172a;
        --input: #0d1322;
        --link: #38bdf8;
        color-scheme: dark;
      }

      body[data-theme='light'] {
        --bg: radial-gradient(circle at 5% 10%, rgba(59, 130, 246, 0.14), transparent 26%),
          radial-gradient(circle at 90% 15%, rgba(16, 185, 129, 0.12), transparent 30%),
          #f4f6fb;
        --panel: #ffffff;
        --panel-border: #e5e7eb;
        --muted: #4b5563;
        --text: #0f172a;
        --surface: #f8fafc;
        --input: #f3f4f6;
        --link: #2563eb;
        color-scheme: light;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        overflow-x: hidden;
      }

      .app-shell {
        width: min(1080px, calc(100vw - 36px));
        max-width: 100%;
        margin: 0 auto;
        padding: clamp(28px, 4vw, 38px) clamp(18px, 3vw, 28px) 96px;
      }

      header.hero {
        display: grid;
        gap: 12px;
        margin-bottom: 28px;
      }

      .eyebrow {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--panel-border);
        width: fit-content;
        font-size: 14px;
        color: var(--muted);
      }

      h1 {
        margin: 0;
        font-size: clamp(28px, 3vw, 36px);
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .hero p { margin: 0; color: var(--muted); max-width: 840px; }

      .hero-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        background: var(--surface);
        color: var(--muted);
      }

      .toggle {
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        background: var(--surface);
        color: var(--text);
        cursor: pointer;
        font-weight: 700;
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(248px, 300px) minmax(0, 1fr);
        gap: 16px;
        align-items: start;
      }

      .grid > *,
      .actions > *,
      .link-preview > *,
      .pill-grid > * {
        min-width: 0;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 18px;
        padding: 22px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.18);
      }

      .panel h2 {
        margin: 0 0 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .panel p.meta { color: var(--muted); margin-top: 4px; margin-bottom: 0; }

      .panel + .panel { margin-top: 16px; }

      label {
        display: block;
        margin: 12px 0 6px;
        font-weight: 600;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        background: var(--input);
        color: var(--text);
        font-size: 16px;
      }

      textarea { min-height: 120px; resize: vertical; }

      .stack { display: grid; gap: 16px; }

      .list {
        list-style: none;
        padding: 0;
        margin: 16px 0 12px;
        display: grid;
        gap: 10px;
      }

      .list li {
        padding: 14px;
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: var(--surface);
        cursor: pointer;
        transition: border-color 0.1s ease, transform 0.1s ease;
        word-break: break-word;
      }

      .list li:hover { border-color: var(--link); transform: translateY(-1px); }
      .list li.active { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.45); }
      .list h3 { margin: 0 0 6px; }
      .meta { color: var(--muted); font-size: 14px; }

      .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

      button {
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }

      button.primary {
        background: linear-gradient(135deg, #fbbf24, var(--accent));
        color: #0f172a;
        box-shadow: 0 12px 30px rgba(251, 191, 36, 0.3);
      }

      button.ghost {
        background: var(--surface);
        color: var(--muted);
        border: 1px solid var(--panel-border);
      }

      button:hover { transform: translateY(-1px); }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: var(--surface);
        border: 1px solid var(--panel-border);
        color: var(--muted);
        font-weight: 600;
      }

      .badge.success { color: var(--positive); }
      .badge.error { color: var(--negative); }

      .business-summary {
        display: grid;
        gap: 6px;
        padding: 14px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px dashed var(--panel-border);
        word-break: break-word;
      }

      .input-inline {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .input-inline > div {
        min-width: 0;
      }

      .preview {
        border: 1px dashed var(--panel-border);
        border-radius: 14px;
        min-height: 220px;
        display: grid;
        place-items: center;
        background: var(--surface);
        padding: 10px;
      }

      .preview img { max-width: 100%; max-height: 220px; border-radius: 12px; }

      .link-preview {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 14px;
        border: 1px dashed var(--panel-border);
        border-radius: 12px;
        background: var(--surface);
      }

      .link-preview small { color: var(--muted); display: block; }
      .link-preview a { word-break: break-all; font-weight: 600; color: var(--link); }

      .pill,
      .badge,
      .meta,
      label,
      input,
      textarea,
      select,
      .history-card,
      .tag,
      .actions,
      .pill-grid,
      .input-inline,
      .link-preview {
        overflow-wrap: anywhere;
      }

      .history {
        display: grid;
        gap: 10px;
      }

      .history-card {
        border: 1px solid var(--panel-border);
        border-radius: 14px;
        padding: 14px;
        background: var(--surface);
      }

      .history-card h3 { margin: 0 0 4px; }

      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0;
      }

      .tag {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid var(--panel-border);
        background: var(--panel);
        color: var(--muted);
        font-size: 13px;
      }

      .pill-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }

      .metric {
        padding: 12px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--panel-border);
      }

      @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
      @media (max-width: 640px) {
        .hero-actions { flex-direction: column; align-items: flex-start; }
        .link-preview { flex-direction: column; align-items: flex-start; }
        button { width: 100%; text-align: center; }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="hero">
        <div class="eyebrow">üîî Panneau d'administration</div>
        <h1>Console Notificator</h1>
        <p>
          G√©rez vos commerces, g√©n√©rez leurs liens d'enr√¥lement et envoyez des notifications Web Push cibl√©es.
          Toutes les actions sont synchronis√©es avec le service worker pour un rendu identique sur desktop et mobile.
        </p>
        <div class="hero-actions">
          <div class="pill">Mode clair/sombre synchronis√© avec la page d'atterrissage</div>
          <div class="pill">Enr√¥lement multi-commerces via lien d√©di√©</div>
          <button id="theme-toggle" class="toggle" type="button">üåô Mode sombre</button>
        </div>
      </header>

      <div class="grid">
        <aside class="panel">
          <div class="stack">
            <div>
              <h2>Commerces</h2>
              <p class="meta">Filtrez, inspectez et rattachez un abonn√© push avant l'envoi cibl√©.</p>
            </div>
            <input id="search" type="search" placeholder="Rechercher par nom, g√©rant ou t√©l√©phone" />
            <ul class="list" id="businesses"></ul>
            <button class="ghost" id="add-business">+ Ajouter un commerce</button>
          </div>
        </aside>

        <main class="stack">
          <section class="panel">
            <div class="actions" style="justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
              <div>
                <h2 id="business-title">Fiche commerce</h2>
                <p class="meta">S√©lectionnez une fiche pour charger les coordonn√©es et pr√©remplir la notification.</p>
              </div>
              <span class="badge" id="business-status">Aucun commerce s√©lectionn√©</span>
            </div>

            <div class="pill-grid">
              <div class="metric">
                <strong>Coordonn√©es enregistr√©es</strong>
                <div class="business-summary" id="business-summary">Choisissez un commerce pour afficher les informations existantes.</div>
              </div>
              <div class="metric">
                <strong>Partager l'inscription</strong>
                <p class="meta">
                  G√©n√©rez un lien unique pour lier un nouvel abonn√© √† ce commerce et m√©moriser son accord dans le navigateur.
                </p>
                <div class="actions" style="margin-top: 8px;">
                  <button class="ghost" id="generate-enrollment-link">üîó Cr√©er le lien</button>
                  <button class="ghost" id="copy-enrollment-link">üìã Copier</button>
                </div>
                <input id="enrollment-link" type="url" placeholder="Lien d'inscription g√©n√©r√© ici" readonly />
                <p class="meta" id="enrollment-hint">S√©lectionnez un commerce pour cr√©er un lien de partage.</p>
              </div>
              <div class="metric">
                <strong>Message d'invitation</strong>
                <p class="meta">Personnalisez la question affich√©e sur la page d'enr√¥lement.</p>
                <input
                  id="enrollment-prompt"
                  type="text"
                  placeholder="Activer les alertes de votre commer√ßant ?"
                  maxlength="180"
                  aria-label="Message d'invitation"
                />
                <div class="actions" style="margin-top: 8px; align-items: center; gap: 12px; flex-wrap: wrap;">
                  <button class="primary" id="save-enrollment-prompt" type="button">üí¨ Mettre √† jour</button>
                  <span class="meta" id="enrollment-prompt-status">Synchro avec la page d'inscription.</span>
                </div>
              </div>
            </div>

            <div class="stack" style="margin-top: 12px;">
              <h3 style="margin: 0;">Modifier ou ajouter</h3>
              <label for="business-name">Nom du commerce</label>
              <input id="business-name" type="text" placeholder="Ex : Boulangerie des Halles" />

              <div class="input-inline">
                <div>
                  <label for="manager-name">Nom du g√©rant</label>
                  <input id="manager-name" type="text" placeholder="Ex : Jeanne Dupont" />
                </div>
                <div>
                  <label for="business-phone">T√©l√©phone</label>
                  <input id="business-phone" type="tel" placeholder="06 12 34 56 78" />
                </div>
              </div>

              <div class="input-inline">
                <div>
                  <label for="business-email">Email</label>
                  <input id="business-email" type="email" placeholder="contact@commerce.fr" />
                </div>
                <div>
                  <label for="business-address">Adresse</label>
                  <input id="business-address" type="text" placeholder="12 rue des Lilas, 75000 Paris" />
                </div>
              </div>

              <label for="business-subscriber-id">ID abonn√© push (optionnel)</label>
              <input id="business-subscriber-id" type="number" placeholder="Associer un abonn√© existant" />

              <div class="actions" style="margin-top: 6px;">
                <button class="primary" id="save-business">Enregistrer le commerce</button>
                <button class="ghost" id="reset-business">R√©initialiser</button>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="actions" style="justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
              <div>
                <h2>Composer une notification</h2>
                <p class="meta">L'image est h√©berg√©e localement, le lien est g√©n√©r√© automatiquement avec la page d'atterrissage.</p>
              </div>
              <span class="badge" id="status">Pr√™t</span>
            </div>

            <div class="input-inline">
              <div>
                <label for="title">Titre</label>
                <input id="title" type="text" placeholder="Nouvelle offre" required />
              </div>
              <div>
                <label for="click-url">Lien de destination</label>
                <input id="click-url" type="url" placeholder="https://votre-landing-page" />
              </div>
            </div>

            <div class="tags">
              <label class="checkbox" for="toggle-call" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="toggle-call" type="checkbox" /> Ajouter le bouton ¬´ Appeler ¬ª
              </label>
              <label class="checkbox" for="toggle-map" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="toggle-map" type="checkbox" /> Ajouter le bouton ¬´ Voir l'adresse ¬ª
              </label>
            </div>

            <div class="input-inline">
              <div>
                <label for="call-number">Num√©ro √† composer</label>
                <input id="call-number" type="tel" placeholder="06 12 34 56 78" />
              </div>
              <div>
                <label for="destination-address">Adresse pour l'itin√©raire</label>
                <input id="destination-address" type="text" placeholder="12 rue des Lilas, Paris" />
              </div>
            </div>

            <label for="body">Contenu</label>
            <textarea id="body" placeholder="D√©tail du message √† afficher dans la pop-up"></textarea>

            <label for="image-file">Image (t√©l√©versement recommand√©)</label>
            <input id="image-file" type="file" accept="image/*" />
            <p class="meta" id="image-upload-status">L'image sera h√©berg√©e localement sur le serveur.</p>

            <label for="image-url">URL de l'image (remplie automatiquement apr√®s envoi)</label>
            <input id="image-url" type="url" placeholder="https://exemple.com/visuel.jpg" />

            <div class="preview" id="image-preview">Pr√©visualisation de l'image</div>

            <div class="link-preview">
              <div>
                <strong>Page d'atterrissage g√©n√©r√©e</strong>
                <small>Fond = image, boutons dynamiques selon les cases coch√©es.</small>
              </div>
              <a id="landing-preview" href="#" target="_blank" rel="noreferrer">Ouvrir l'aper√ßu</a>
            </div>

            <div class="actions" style="margin-top: 10px;">
              <button class="primary" id="send" style="display:flex; align-items:center; gap:8px;">üîî Envoyer / renvoyer</button>
              <span class="badge">La notification est envoy√©e √† tous les abonn√©s ou au commerce s√©lectionn√©.</span>
            </div>
          </section>

          <section class="panel">
            <div class="actions" style="justify-content: space-between; align-items: center;">
              <div>
                <h2>Historique des notifications</h2>
                <p class="meta">Suivez les derniers envois et ouvrez la landing page associ√©e.</p>
              </div>
              <span class="badge">Derniers √©v√©nements</span>
            </div>
            <div class="history" id="history"></div>
          </section>
        </main>
      </div>
    </div>

    <script>
      const status = document.getElementById('status');
      const history = document.getElementById('history');
      const businessList = document.getElementById('businesses');
      const search = document.getElementById('search');
      const addBusinessBtn = document.getElementById('add-business');
      const saveBusinessBtn = document.getElementById('save-business');
      const resetBusinessBtn = document.getElementById('reset-business');
      const businessStatus = document.getElementById('business-status');
      const businessSummary = document.getElementById('business-summary');
      const businessTitle = document.getElementById('business-title');

      const titleInput = document.getElementById('title');
      const bodyInput = document.getElementById('body');
      const imageFileInput = document.getElementById('image-file');
      const imageUploadStatus = document.getElementById('image-upload-status');
      const imageInput = document.getElementById('image-url');
      const imagePreview = document.getElementById('image-preview');
      const clickUrlInput = document.getElementById('click-url');
      const enrollmentLinkInput = document.getElementById('enrollment-link');
      const generateEnrollmentBtn = document.getElementById('generate-enrollment-link');
      const copyEnrollmentBtn = document.getElementById('copy-enrollment-link');
      const enrollmentHint = document.getElementById('enrollment-hint');
      const enrollmentPromptInput = document.getElementById('enrollment-prompt');
      const enrollmentPromptStatus = document.getElementById('enrollment-prompt-status');
      const saveEnrollmentPromptBtn = document.getElementById('save-enrollment-prompt');
      copyEnrollmentBtn.disabled = true;

      const businessForm = {
        name: document.getElementById('business-name'),
        manager: document.getElementById('manager-name'),
        phone: document.getElementById('business-phone'),
        email: document.getElementById('business-email'),
        address: document.getElementById('business-address'),
        subscriberId: document.getElementById('business-subscriber-id'),
      };

      const callToggle = document.getElementById('toggle-call');
      const mapToggle = document.getElementById('toggle-map');
      const callNumberInput = document.getElementById('call-number');
      const destinationAddressInput = document.getElementById('destination-address');
      const landingPreviewLink = document.getElementById('landing-preview');
      const themeToggle = document.getElementById('theme-toggle');

      let businesses = [];
      let selectedBusinessId = null;

      function applyTheme(theme) {
        const nextTheme = theme || localStorage.getItem('notificator-theme') || 'dark';
        document.body.setAttribute('data-theme', nextTheme);
        localStorage.setItem('notificator-theme', nextTheme);
        themeToggle.textContent = nextTheme === 'dark' ? 'üåû Mode clair' : 'üåô Mode sombre';
      }

      function toggleTheme() {
        const current = document.body.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        syncLandingLink();
      }

      function renderPreview() {
        const url = imageInput.value.trim();
        if (!url) {
          imagePreview.innerHTML = "Pr√©visualisation de l'image";
          return;
        }
        imagePreview.innerHTML = `<img src="${url}" alt="Pr√©visualisation" />`;
      }

      async function uploadLocalImage(file) {
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        imageUploadStatus.textContent = 'T√©l√©versement en cours...';
        imageUploadStatus.style.color = '#9ca3af';
        try {
          const response = await fetch('/api/uploads', {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            const message = error?.detail || "Impossible d'enregistrer l'image.";
            throw new Error(message);
          }
          const data = await response.json();
          imageInput.value = data.url;
          renderPreview();
          syncLandingLink();
          imageUploadStatus.textContent = 'Image h√©berg√©e localement et pr√™te √† √™tre envoy√©e.';
          imageUploadStatus.style.color = '#9ca3af';
        } catch (error) {
          console.error(error);
          imageUploadStatus.textContent = error.message;
          imageUploadStatus.style.color = '#f87171';
        }
      }

      function buildLandingLink() {
        const landingUrl = new URL(`${window.location.origin}/notification.html`);
        const imageUrl = imageInput.value.trim();
        const title = titleInput.value.trim();
        const body = bodyInput.value.trim();
        const callNumber = callNumberInput.value.trim();
        const destinationAddress = destinationAddressInput.value.trim();

        if (imageUrl) landingUrl.searchParams.set('image', imageUrl);
        if (title) landingUrl.searchParams.set('title', title);
        if (body) landingUrl.searchParams.set('body', body);
        if (callToggle.checked && callNumber) landingUrl.searchParams.set('call', callNumber);
        if (mapToggle.checked && destinationAddress) landingUrl.searchParams.set('address', destinationAddress);

        return landingUrl.toString();
      }

      function syncLandingLink() {
        const link = buildLandingLink();
        clickUrlInput.value = link;
        landingPreviewLink.href = link;
      }

      function renderBusinessSummary(business) {
        if (!business) {
          businessSummary.innerHTML = 'Choisissez un commerce pour afficher les informations existantes.';
          return;
        }
        businessSummary.innerHTML = `
          <p><strong>Nom :</strong> ${business.name}</p>
          <p><strong>G√©rant :</strong> ${business.manager_name || 'Non renseign√©'}</p>
          <p><strong>T√©l√©phone :</strong> ${business.phone || 'Non renseign√©'}</p>
          <p><strong>Email :</strong> ${business.email || 'Non renseign√©'}</p>
          <p><strong>Adresse :</strong> ${business.address || 'Non renseign√©e'}</p>
          <p><strong>ID abonn√© push :</strong> ${business.subscriber_id || 'Non associ√©'}</p>
        `;
      }

      function buildEnrollmentLink(business) {
        const url = new URL(`${window.location.origin}/index.html`);
        url.searchParams.set('business_id', business.id);
        url.searchParams.set('business_name', business.name);
        return url.toString();
      }

      function renderEnrollmentLink(business) {
        if (!business) {
          enrollmentLinkInput.value = '';
          enrollmentHint.textContent = 'S√©lectionnez un commerce pour cr√©er un lien de partage.';
          copyEnrollmentBtn.disabled = true;
          return;
        }

        enrollmentLinkInput.value = buildEnrollmentLink(business);
        enrollmentHint.textContent =
          "Partagez ce lien : la page affichera un Oui/Non simple, enregistrera le commerce et ne reposera plus la question sur cet appareil.";
        copyEnrollmentBtn.disabled = false;
      }

      function populateBusinessForm(business) {
        businessForm.name.value = business?.name || '';
        businessForm.manager.value = business?.manager_name || '';
        businessForm.phone.value = business?.phone || '';
        businessForm.email.value = business?.email || '';
        businessForm.address.value = business?.address || '';
        businessForm.subscriberId.value = business?.subscriber_id || '';
        callNumberInput.value = business?.phone || '';
        destinationAddressInput.value = business?.address || '';
        syncLandingLink();
      }

      function highlightSelection() {
        Array.from(businessList.children).forEach((li) => {
          li.classList.toggle('active', Number(li.dataset.id) === selectedBusinessId);
        });
      }

      function renderBusinessList(items) {
        businessList.innerHTML = '';
        if (!items.length) {
          const empty = document.createElement('li');
          empty.innerHTML = '<div class="meta">Aucun commerce trouv√©.</div>';
          businessList.appendChild(empty);
          return;
        }
        items.forEach((business) => {
          const li = document.createElement('li');
          li.dataset.id = business.id;
          li.innerHTML = `
            <h3>${business.name}</h3>
            <div class="meta">${business.manager_name || 'G√©rant inconnu'}${business.phone ? ` ‚Ä¢ ${business.phone}` : ''}</div>
          `;
          li.addEventListener('click', () => selectBusiness(business.id));
          businessList.appendChild(li);
        });
        highlightSelection();
      }

      function filterBusinesses() {
        const query = search.value.toLowerCase();
        const filtered = businesses.filter(
          (b) =>
            !query ||
            b.name.toLowerCase().includes(query) ||
            (b.manager_name && b.manager_name.toLowerCase().includes(query)) ||
            (b.phone && b.phone.toLowerCase().includes(query))
        );
        renderBusinessList(filtered);
      }

      function generateEnrollmentLink() {
        const business = businesses.find((b) => b.id === selectedBusinessId);
        if (!business) {
          enrollmentLinkInput.value = '';
          enrollmentHint.textContent = 'S√©lectionnez un commerce avant de g√©n√©rer un lien.';
          copyEnrollmentBtn.disabled = true;
          businessStatus.textContent = 'Aucun commerce s√©lectionn√© pour le lien.';
          businessStatus.style.color = '#f87171';
          return;
        }

        renderEnrollmentLink(business);
        businessStatus.textContent = "Lien d'enr√¥lement g√©n√©r√© pour ce commerce";
        businessStatus.style.color = '#34d399';
      }

      async function copyEnrollmentLink() {
        if (!enrollmentLinkInput.value) {
          businessStatus.textContent = 'G√©n√©rez un lien avant de copier';
          businessStatus.style.color = '#f87171';
          return;
        }

        try {
          await navigator.clipboard.writeText(enrollmentLinkInput.value);
          businessStatus.textContent = 'Lien copi√© dans le presse-papiers';
          businessStatus.style.color = '#34d399';
        } catch (error) {
          console.error(error);
          businessStatus.textContent = 'Impossible de copier le lien';
          businessStatus.style.color = '#f87171';
        }
      }

      async function loadEnrollmentPrompt() {
        if (!enrollmentPromptInput) return;
        enrollmentPromptStatus.textContent = 'Chargement du message...';
        enrollmentPromptStatus.style.color = '#9ca3af';
        try {
          const response = await fetch('/api/settings/enrollment_prompt');
          if (!response.ok) throw new Error();
          const data = await response.json();
          enrollmentPromptInput.value = data.value || '';
          enrollmentPromptStatus.textContent = 'Message synchronis√© avec la page d\'enr√¥lement.';
          enrollmentPromptStatus.style.color = '#9ca3af';
        } catch (error) {
          enrollmentPromptStatus.textContent = 'Impossible de charger le message actuel';
          enrollmentPromptStatus.style.color = '#f87171';
        }
      }

      async function saveEnrollmentPrompt() {
        if (!enrollmentPromptInput) return;
        const value = enrollmentPromptInput.value.trim();
        if (!value) {
          enrollmentPromptStatus.textContent = 'Le message ne peut pas √™tre vide';
          enrollmentPromptStatus.style.color = '#f87171';
          return;
        }

        saveEnrollmentPromptBtn.disabled = true;
        enrollmentPromptStatus.textContent = 'Enregistrement...';
        enrollmentPromptStatus.style.color = '#9ca3af';

        try {
          const response = await fetch('/api/settings/enrollment_prompt', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ value }),
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            const message = error?.detail || 'Erreur lors de la mise √† jour du message';
            throw new Error(message);
          }

          const data = await response.json();
          enrollmentPromptInput.value = data.value;
          enrollmentPromptStatus.textContent = 'Message mis √† jour avec succ√®s.';
          enrollmentPromptStatus.style.color = '#34d399';
        } catch (error) {
          console.error(error);
          enrollmentPromptStatus.textContent = error.message;
          enrollmentPromptStatus.style.color = '#f87171';
        } finally {
          saveEnrollmentPromptBtn.disabled = false;
        }
      }

      async function fetchBusinesses() {
        const response = await fetch('/api/businesses');
        if (!response.ok) return;
        businesses = await response.json();
        filterBusinesses();
        if (selectedBusinessId) {
          const existing = businesses.find((b) => b.id === selectedBusinessId);
          if (existing) {
            selectBusiness(existing.id, false);
          } else {
            resetBusinessForm();
          }
        }
      }

      function resetBusinessForm() {
        selectedBusinessId = null;
        businessTitle.textContent = 'Fiche commerce';
        businessStatus.textContent = 'Aucun commerce s√©lectionn√©';
        businessStatus.style.color = '#9ca3af';
        populateBusinessForm(null);
        renderBusinessSummary(null);
        renderEnrollmentLink(null);
        highlightSelection();
      }

      function selectBusiness(id, updateList = true) {
        const business = businesses.find((b) => b.id === id);
        if (!business) {
          resetBusinessForm();
          return;
        }
        selectedBusinessId = business.id;
        businessTitle.textContent = `Fiche commerce ¬∑ ${business.name}`;
        businessStatus.textContent = 'Pr√™t pour modification ou envoi';
        businessStatus.style.color = '#34d399';
        populateBusinessForm(business);
        renderBusinessSummary(business);
        renderEnrollmentLink(business);
        if (updateList) highlightSelection();
      }

      async function saveBusiness() {
        businessStatus.style.color = '#9ca3af';
        const payload = {
          name: businessForm.name.value.trim(),
          manager_name: businessForm.manager.value.trim() || null,
          phone: businessForm.phone.value.trim() || null,
          email: businessForm.email.value.trim() || null,
          address: businessForm.address.value.trim() || null,
          subscriber_id: businessForm.subscriberId.value ? Number(businessForm.subscriberId.value) : null,
        };

        if (!payload.name) {
          businessStatus.textContent = 'Le nom du commerce est requis';
          businessStatus.style.color = '#f87171';
          return;
        }

        const isNew = !selectedBusinessId;
        const url = isNew ? '/api/businesses' : `/api/businesses/${selectedBusinessId}`;
        const method = isNew ? 'POST' : 'PUT';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          businessStatus.textContent = 'Erreur lors de la sauvegarde du commerce';
          businessStatus.style.color = '#f87171';
          return;
        }

        const saved = await response.json();
        businessStatus.textContent = isNew ? 'Commerce ajout√©' : 'Commerce mis √† jour';
        businessStatus.style.color = '#34d399';
        await fetchBusinesses();
        selectBusiness(saved.id);
      }

      async function fetchHistory() {
        const response = await fetch('/api/notifications');
        if (!response.ok) return;
        const items = await response.json();
        history.innerHTML = '';
        if (!items.length) {
          history.innerHTML = '<div class="meta">Aucune notification envoy√©e pour le moment.</div>';
          return;
        }
        items.forEach((item) => {
          const li = document.createElement('div');
          li.className = 'history-card';
          li.innerHTML = `
            <h3>${item.title}</h3>
            <div class="meta">${new Date(item.created_at).toLocaleString()}</div>
            ${item.business ? `<div class="tag">Commerce : ${item.business.name}</div>` : ''}
            <div>${item.body || 'Pas de message'}</div>
            ${item.image_url ? `<div style="margin-top:8px;"><img src="${item.image_url}" alt="visuel" style="max-width:100%; border-radius:10px;" /></div>` : ''}
            ${item.click_url ? `<div class="meta">Lien : <a href="${item.click_url}" target="_blank" rel="noreferrer">${item.click_url}</a></div>` : ''}
          `;
          history.appendChild(li);
        });
      }

      async function sendNotification() {
        status.textContent = selectedBusinessId ? 'Envoi cibl√©...' : 'Envoi en cours...';
        status.style.color = '#9ca3af';

        syncLandingLink();

        const targetBusiness = businesses.find((b) => b.id === selectedBusinessId);
        if (selectedBusinessId && targetBusiness && !targetBusiness.subscriber_id) {
          status.textContent = "Associez un abonn√© push √† ce commerce avant l'envoi";
          status.style.color = '#f87171';
          return;
        }

        const payload = {
          title: titleInput.value,
          body: bodyInput.value || null,
          image_url: imageInput.value || null,
          click_url: clickUrlInput.value || null,
          business_id: selectedBusinessId,
        };

        const response = await fetch('/api/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          status.textContent = 'Erreur lors de la publication';
          status.style.color = '#f87171';
          return;
        }

        status.textContent = selectedBusinessId ? 'Notification envoy√©e √† ce commerce' : 'Notification envoy√©e';
        status.style.color = '#34d399';
        await fetchHistory();
      }

      addBusinessBtn.addEventListener('click', resetBusinessForm);
      saveBusinessBtn.addEventListener('click', saveBusiness);
      resetBusinessBtn.addEventListener('click', resetBusinessForm);
      document.getElementById('send').addEventListener('click', sendNotification);
      imageFileInput.addEventListener('change', async (event) => {
        const [file] = event.target.files;
        if (file) {
          await uploadLocalImage(file);
        } else {
          imageUploadStatus.textContent = "L'image sera h√©berg√©e localement sur le serveur.";
          imageUploadStatus.style.color = '#9ca3af';
        }
      });
      imageInput.addEventListener('input', () => {
        renderPreview();
        syncLandingLink();
      });
      titleInput.addEventListener('input', syncLandingLink);
      bodyInput.addEventListener('input', syncLandingLink);
      callNumberInput.addEventListener('input', syncLandingLink);
      destinationAddressInput.addEventListener('input', syncLandingLink);
      callToggle.addEventListener('change', syncLandingLink);
      mapToggle.addEventListener('change', syncLandingLink);
      themeToggle.addEventListener('click', toggleTheme);
      search.addEventListener('input', filterBusinesses);
      generateEnrollmentBtn.addEventListener('click', generateEnrollmentLink);
      copyEnrollmentBtn.addEventListener('click', copyEnrollmentLink);
      saveEnrollmentPromptBtn.addEventListener('click', saveEnrollmentPrompt);

      applyTheme();
      renderPreview();
      syncLandingLink();
      loadEnrollmentPrompt();
      fetchHistory();
      fetchBusinesses();
    </script>
  </body>
</html>
