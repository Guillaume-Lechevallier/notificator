<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notificator - Administration</title>
    <style>
      :root { font-family: 'Inter', system-ui, sans-serif; background: #0b1220; color: #e6edf3; }
      body { margin: 0 auto; max-width: 960px; padding: 48px 24px 96px; }
      h1 { display: flex; align-items: center; gap: 12px; }
      .panel { background: #0f172a; border: 1px solid #1f2937; border-radius: 18px; padding: 24px; box-shadow: 0 12px 60px rgba(0,0,0,0.32); margin-bottom: 20px; }
      label { display: block; font-weight: 600; margin: 12px 0 6px; }
      input, textarea { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #1f2937; background: #0b1220; color: #e6edf3; font-size: 16px; box-sizing: border-box; }
      textarea { min-height: 96px; resize: vertical; }
      .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 16px; }
      button { border: none; border-radius: 12px; padding: 12px 18px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; color: #0b1220; }
      .primary { background: linear-gradient(135deg, #fbbf24, #f59e0b); box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3); }
      .primary:hover { transform: translateY(-1px); }
      .ghost { background: #0b1220; color: #9ca3af; border: 1px solid #1f2937; }
      .badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: #111827; border: 1px solid #1f2937; color: #9ca3af; }
      .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
      .list li { background: #0b1220; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; }
      .list h3 { margin: 0 0 6px; }
      .meta { color: #9ca3af; font-size: 14px; }
      .bell { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
      .bell-icon { background: #f59e0b; color: #111827; border-radius: 50%; width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; font-size: 22px; }
      a { color: #38bdf8; }
    </style>
  </head>
  <body>
    <h1><span class="bell-icon">ðŸ””</span> Panneau d'administration</h1>
    <p>Publiez une notification illustrÃ©e : un message, une image et une URL d'atterrissage. Les abonnÃ©s verront une pop-up cliquable.</p>

    <section class="panel">
      <h2>Composer une notification</h2>
      <label for="title">Titre</label>
      <input id="title" type="text" placeholder="Nouveau visuel disponible" required />
      <label for="body">Texte (optionnel)</label>
      <textarea id="body" placeholder="Ajoutez un message pour vos abonnÃ©s"></textarea>
      <label for="image">URL de l'image</label>
      <input id="image" type="url" placeholder="https://exemple.com/image.jpg" required />
      <label for="target">Lien cible</label>
      <input id="target" type="url" placeholder="https://exemple.com/landing" required />
      <div class="actions">
        <button class="primary bell" id="send"><span>ðŸ””</span> Envoyer la notification</button>
        <button class="ghost" type="button" id="preview">AperÃ§u</button>
        <span class="badge" id="status">PrÃªt</span>
      </div>
    </section>

    <section class="panel">
      <h2>Historique des notifications</h2>
      <ul class="list" id="history"></ul>
    </section>

    <script>
      const status = document.getElementById('status');
      const history = document.getElementById('history');
      const titleInput = document.getElementById('title');
      const bodyInput = document.getElementById('body');
      const imageInput = document.getElementById('image');
      const targetInput = document.getElementById('target');

      async function fetchHistory() {
        const response = await fetch('/api/notifications');
        if (!response.ok) return;
        const items = await response.json();
        history.innerHTML = '';
        items.forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<h3>${item.title}</h3><div class="meta">${new Date(item.created_at).toLocaleString()}</div><div>${item.body || 'Pas de message'}</div><div class="meta">Image : <a href="${item.image_url}" target="_blank" rel="noreferrer">${item.image_url}</a></div><div class="meta">Cible : <a href="${item.target_url}" target="_blank" rel="noreferrer">${item.target_url}</a></div>`;
          history.appendChild(li);
        });
      }

      async function sendNotification() {
        status.textContent = 'Envoi en cours...';
        const response = await fetch('/api/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: titleInput.value,
            body: bodyInput.value || null,
            image_url: imageInput.value,
            target_url: targetInput.value,
          }),
        });

        if (!response.ok) {
          status.textContent = 'Erreur lors de la publication';
          status.style.color = '#f87171';
          return;
        }

        status.textContent = 'Notification envoyÃ©e';
        status.style.color = '#34d399';
        await fetchHistory();
      }

      document.getElementById('send').addEventListener('click', sendNotification);
      document.getElementById('preview').addEventListener('click', () => {
        const url = `/notification.html?image=${encodeURIComponent(imageInput.value)}&target=${encodeURIComponent(targetInput.value)}`;
        window.open(url, '_blank');
      });

      fetchHistory();
    </script>
  </body>
</html>
