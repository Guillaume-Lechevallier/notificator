<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notificator - Administration</title>
    <style>
      :root { font-family: 'Inter', system-ui, sans-serif; background: #0b1220; color: #e6edf3; }
      body { margin: 0 auto; max-width: 1200px; padding: 32px 24px 96px; }
      h1 { display: flex; align-items: center; gap: 12px; }
      .layout { display: grid; grid-template-columns: 320px 1fr; gap: 18px; align-items: start; }
      .panel { background: #0f172a; border: 1px solid #1f2937; border-radius: 18px; padding: 24px; box-shadow: 0 12px 60px rgba(0,0,0,0.32); margin-bottom: 20px; }
      label { display: block; font-weight: 600; margin: 12px 0 6px; }
      input, textarea { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #1f2937; background: #0b1220; color: #e6edf3; font-size: 16px; box-sizing: border-box; }
      textarea { min-height: 120px; resize: vertical; }
      .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 16px; }
      button { border: none; border-radius: 12px; padding: 12px 18px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; color: #0b1220; }
      .primary { background: linear-gradient(135deg, #fbbf24, #f59e0b); box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3); }
      .primary:hover { transform: translateY(-1px); }
      .ghost { background: #0b1220; color: #9ca3af; border: 1px solid #1f2937; }
      .badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: #111827; border: 1px solid #1f2937; color: #9ca3af; }
      .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
      .list li { background: #0b1220; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; }
      .list h3 { margin: 0 0 6px; }
      .meta { color: #9ca3af; font-size: 14px; }
      .bell { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
      .bell-icon { background: #f59e0b; color: #111827; border-radius: 50%; width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; font-size: 22px; }
      .preview { border: 1px dashed #1f2937; border-radius: 14px; min-height: 220px; display: grid; place-items: center; background: #0b1220; }
      .preview img { max-width: 100%; max-height: 220px; border-radius: 12px; }
      .sidebar { position: sticky; top: 24px; }
      .input-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .subtitle { color: #9ca3af; margin-top: 0; }
      a { color: #38bdf8; }
      @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } .sidebar { position: static; } }
    </style>
  </head>
  <body>
    <h1><span class="bell-icon">ðŸ””</span> Panneau d'administration</h1>
    <p>Publiez des notifications Web Push avec image et lien de redirection. Le service worker affichera la pop-up sur desktop et mobile.</p>

    <div class="layout">
      <aside class="panel sidebar">
        <h2>Destinataires</h2>
        <p class="subtitle">Recherche par nom de commerce ou token.</p>
        <input id="search" type="search" placeholder="rechercher" />
        <ul class="list" id="audience"></ul>
      </aside>

      <main>
        <section class="panel">
          <h2>Composer une notification</h2>
          <div class="input-inline">
            <div>
              <label for="title">Titre</label>
              <input id="title" type="text" placeholder="Nouvelle offre" required />
            </div>
            <div>
              <label for="click-url">Lien de destination</label>
              <input id="click-url" type="url" placeholder="https://votre-landing-page" />
            </div>
          </div>
          <label for="body">Contenu</label>
          <textarea id="body" placeholder="DÃ©tail du message Ã  afficher dans la pop-up"></textarea>
          <label for="image-url">Image</label>
          <input id="image-url" type="url" placeholder="https://exemple.com/visuel.jpg" />
          <div class="preview" id="image-preview">PrÃ©visualisation de l'image</div>
          <div class="actions">
            <button class="primary bell" id="send"><span>ðŸ””</span> Envoyer la notification</button>
            <span class="badge" id="status">PrÃªt</span>
          </div>
        </section>

        <section class="panel">
          <h2>Historique des notifications</h2>
          <ul class="list" id="history"></ul>
        </section>
      </main>
    </div>

    <script>
      const status = document.getElementById('status');
      const history = document.getElementById('history');
      const audience = document.getElementById('audience');
      const search = document.getElementById('search');
      const titleInput = document.getElementById('title');
      const bodyInput = document.getElementById('body');
      const imageInput = document.getElementById('image-url');
      const imagePreview = document.getElementById('image-preview');
      const clickUrlInput = document.getElementById('click-url');

      function renderPreview() {
        const url = imageInput.value.trim();
        if (!url) {
          imagePreview.innerHTML = 'PrÃ©visualisation de l\'image';
          return;
        }
        imagePreview.innerHTML = `<img src="${url}" alt="PrÃ©visualisation" />`;
      }

      async function fetchHistory() {
        const response = await fetch('/api/notifications');
        if (!response.ok) return;
        const items = await response.json();
        history.innerHTML = '';
        items.forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <h3>${item.title}</h3>
            <div class="meta">${new Date(item.created_at).toLocaleString()}</div>
            <div>${item.body || 'Pas de message'}</div>
            ${item.image_url ? `<div style="margin-top:8px;"><img src="${item.image_url}" alt="visuel" style="max-width:100%; border-radius:10px;" /></div>` : ''}
            ${item.click_url ? `<div class="meta">Lien : <a href="${item.click_url}" target="_blank" rel="noreferrer">${item.click_url}</a></div>` : ''}
          `;
          history.appendChild(li);
        });
      }

      async function fetchAudience() {
        const response = await fetch('/api/subscribers');
        if (!response.ok) return;
        const items = await response.json();
        audience.dataset.all = JSON.stringify(items);
        renderAudience(items);
      }

      function renderAudience(items) {
        audience.innerHTML = '';
        const query = search.value.toLowerCase();
        items
          .filter((sub) =>
            !query ||
            (sub.label && sub.label.toLowerCase().includes(query)) ||
            sub.device_token.toLowerCase().includes(query)
          )
          .forEach((sub) => {
            const li = document.createElement('li');
            li.innerHTML = `<h3>${sub.label || 'Sans nom'}</h3><div class="meta">${sub.device_token.slice(0, 12)}...</div>`;
            audience.appendChild(li);
          });
      }

      async function sendNotification() {
        status.textContent = 'Envoi en cours...';
        const response = await fetch('/api/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: titleInput.value,
            body: bodyInput.value || null,
            image_url: imageInput.value || null,
            click_url: clickUrlInput.value || null,
          }),
        });

        if (!response.ok) {
          status.textContent = 'Erreur lors de la publication';
          status.style.color = '#f87171';
          return;
        }

        status.textContent = 'Notification envoyÃ©e';
        status.style.color = '#34d399';
        await fetchHistory();
      }

      document.getElementById('send').addEventListener('click', sendNotification);
      imageInput.addEventListener('input', renderPreview);
      search.addEventListener('input', () => {
        const items = JSON.parse(audience.dataset.all || '[]');
        renderAudience(items);
      });
      fetchHistory();
      fetchAudience();
    </script>
  </body>
</html>
