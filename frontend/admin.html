<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notificator - Administration</title>
    <style>
      :root {
        font-family: 'Inter', system-ui, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        --bg-color: #0b1220;
        --panel-color: #0f172a;
        --panel-border: #1f2937;
        --muted: #9ca3af;
        --accent: #f59e0b;
        --surface-contrast: #0b1220;
        --link: #38bdf8;
        color-scheme: dark;
      }
      body[data-theme='light'] {
        --bg-color: #f7f8fb;
        --panel-color: #ffffff;
        --panel-border: #e5e7eb;
        --surface-contrast: #f2f4f8;
        --muted: #4b5563;
        --text-color: #0f172a;
        --link: #2563eb;
        color-scheme: light;
      }
      body { margin: 0 auto; max-width: 1200px; padding: 32px 24px 96px; background: var(--bg-color); }
      h1 { display: flex; align-items: center; gap: 12px; justify-content: space-between; }
      .title-group { display: flex; align-items: center; gap: 12px; }
      .layout { display: grid; grid-template-columns: 320px 1fr; gap: 18px; align-items: start; }
      .panel { background: var(--panel-color); border: 1px solid var(--panel-border); border-radius: 18px; padding: 24px; box-shadow: 0 12px 60px rgba(0,0,0,0.12); margin-bottom: 20px; }
      label { display: block; font-weight: 600; margin: 12px 0 6px; }
      input, textarea { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--panel-border); background: var(--surface-contrast); color: var(--text-color); font-size: 16px; box-sizing: border-box; }
      textarea { min-height: 120px; resize: vertical; }
      .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 16px; }
      button { border: none; border-radius: 12px; padding: 12px 18px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; color: #0b1220; }
      .primary { background: linear-gradient(135deg, #fbbf24, var(--accent)); box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3); }
      .primary:hover { transform: translateY(-1px); }
      .ghost { background: var(--surface-contrast); color: var(--muted); border: 1px solid var(--panel-border); }
      .badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: var(--surface-contrast); border: 1px solid var(--panel-border); color: var(--muted); }
      .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
      .list li { background: var(--surface-contrast); border: 1px solid var(--panel-border); border-radius: 12px; padding: 16px; cursor: pointer; }
      .list li.active { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.4); }
      .list h3 { margin: 0 0 6px; }
      .meta { color: var(--muted); font-size: 14px; }
      .bell { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
      .bell-icon { background: var(--accent); color: #111827; border-radius: 50%; width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; font-size: 22px; }
      .preview { border: 1px dashed var(--panel-border); border-radius: 14px; min-height: 220px; display: grid; place-items: center; background: var(--surface-contrast); }
      .preview img { max-width: 100%; max-height: 220px; border-radius: 12px; }
      .sidebar { position: sticky; top: 24px; }
      .input-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .subtitle { color: var(--muted); margin-top: 0; }
      a { color: var(--link); }
      .full { width: 100%; text-align: center; }
      .business-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
      .summary-card { background: var(--surface-contrast); border: 1px dashed var(--panel-border); border-radius: 12px; padding: 14px; min-height: 180px; }
      .summary-card p { margin: 8px 0; }
      .section-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      .toggle { padding: 10px 14px; color: var(--text-color); background: var(--surface-contrast); border: 1px solid var(--panel-border); border-radius: 12px; cursor: pointer; }
      .toggles { display: flex; align-items: center; gap: 10px; }
      .checkbox { display: inline-flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text-color); }
      .link-preview { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px; border-radius: 12px; border: 1px dashed var(--panel-border); background: var(--surface-contrast); }
      .link-preview small { color: var(--muted); display: block; }
      .link-preview a { word-break: break-all; font-weight: 600; }
      @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } .sidebar { position: static; } .business-grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <h1>
      <span class="title-group"><span class="bell-icon">ðŸ””</span> Panneau d'administration</span>
      <div class="toggles">
        <button id="theme-toggle" class="toggle" type="button">ðŸŒ™ Mode sombre</button>
      </div>
    </h1>
    <p>Publiez des notifications Web Push avec image et lien de redirection. Le service worker affichera la pop-up sur desktop et mobile.</p>

    <div class="layout">
      <aside class="panel sidebar">
        <h2>Commerces</h2>
        <p class="subtitle">SÃ©lectionnez un commerce pour afficher et modifier ses coordonnÃ©es.</p>
        <input id="search" type="search" placeholder="rechercher" />
        <ul class="list" id="businesses"></ul>
        <button class="ghost full" id="add-business">+ Ajouter un commerce</button>
      </aside>

      <main>
        <section class="panel">
          <div class="section-header">
            <h2 id="business-title">Fiche commerce</h2>
            <span class="badge" id="business-status">Aucun commerce sÃ©lectionnÃ©</span>
          </div>
          <div class="business-grid">
            <div>
              <h3>Informations enregistrÃ©es</h3>
              <div class="summary-card" id="business-summary">Choisissez un commerce pour afficher les informations existantes.</div>
              <div class="actions">
                <button class="ghost" id="generate-enrollment-link">ðŸ”— GÃ©nÃ©rer un lien d'enrÃ´lement</button>
                <button class="ghost" id="copy-enrollment-link">ðŸ“‹ Copier</button>
              </div>
              <input id="enrollment-link" type="url" placeholder="Lien d'inscription pour ce commerce" readonly />
              <p class="meta" id="enrollment-hint">SÃ©lectionnez un commerce pour crÃ©er un lien de partage.</p>
            </div>
            <div>
              <h3>Modifier ou ajouter</h3>
              <label for="business-name">Nom du commerce</label>
              <input id="business-name" type="text" placeholder="Ex : Boulangerie des Halles" />
              <div class="input-inline">
                <div>
                  <label for="manager-name">Nom du gÃ©rant</label>
                  <input id="manager-name" type="text" placeholder="Ex : Jeanne Dupont" />
                </div>
                <div>
                  <label for="business-phone">TÃ©lÃ©phone</label>
                  <input id="business-phone" type="tel" placeholder="06 12 34 56 78" />
                </div>
              </div>
              <label for="business-email">Email</label>
              <input id="business-email" type="email" placeholder="contact@commerce.fr" />
              <label for="business-address">Adresse</label>
              <input id="business-address" type="text" placeholder="12 rue des Lilas, 75000 Paris" />
              <label for="business-subscriber-id">ID abonnÃ© push (optionnel)</label>
              <input id="business-subscriber-id" type="number" placeholder="Associer un abonnÃ© existant" />
              <div class="actions">
                <button class="primary" id="save-business">Enregistrer le commerce</button>
                <button class="ghost" id="reset-business">RÃ©initialiser</button>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <h2>Composer une notification</h2>
          <div class="input-inline">
            <div>
              <label for="title">Titre</label>
              <input id="title" type="text" placeholder="Nouvelle offre" required />
            </div>
            <div>
              <label for="click-url">Lien de destination</label>
              <input id="click-url" type="url" placeholder="https://votre-landing-page" />
            </div>
          </div>
          <div class="input-inline">
            <label class="checkbox" for="toggle-call"><input id="toggle-call" type="checkbox" /> Ajouter le bouton Â«&nbsp;Appeler&nbsp;Â»</label>
            <label class="checkbox" for="toggle-map"><input id="toggle-map" type="checkbox" /> Ajouter le bouton Â«&nbsp;Voir l'adresse&nbsp;Â»</label>
          </div>
          <div class="input-inline">
            <div>
              <label for="call-number">NumÃ©ro Ã  composer</label>
              <input id="call-number" type="tel" placeholder="06 12 34 56 78" />
            </div>
            <div>
              <label for="destination-address">Adresse pour l'itinÃ©raire</label>
              <input id="destination-address" type="text" placeholder="12 rue des Lilas, Paris" />
            </div>
          </div>
          <label for="body">Contenu</label>
          <textarea id="body" placeholder="DÃ©tail du message Ã  afficher dans la pop-up"></textarea>
          <label for="image-file">Image (tÃ©lÃ©versement recommandÃ©)</label>
          <input id="image-file" type="file" accept="image/*" />
          <p class="meta" id="image-upload-status">L'image sera hÃ©bergÃ©e localement sur le serveur.</p>
          <label for="image-url">URL de l'image (remplie automatiquement aprÃ¨s envoi)</label>
          <input id="image-url" type="url" placeholder="https://exemple.com/visuel.jpg" />
          <div class="preview" id="image-preview">PrÃ©visualisation de l'image</div>
          <div class="link-preview">
            <div>
              <strong>Page d'atterrissage gÃ©nÃ©rÃ©e</strong>
              <small>Fond = image, boutons dynamiques selon les cases cochÃ©es.</small>
            </div>
            <a id="landing-preview" href="#" target="_blank" rel="noreferrer">Ouvrir l'aperÃ§u</a>
          </div>
          <div class="actions">
            <button class="primary bell" id="send"><span>ðŸ””</span> Envoyer / renvoyer la notification</button>
            <span class="badge" id="status">PrÃªt</span>
          </div>
        </section>

        <section class="panel">
          <h2>Historique des notifications</h2>
          <ul class="list" id="history"></ul>
        </section>
      </main>
    </div>

    <script>
      const status = document.getElementById('status');
      const history = document.getElementById('history');
      const businessList = document.getElementById('businesses');
      const search = document.getElementById('search');
      const addBusinessBtn = document.getElementById('add-business');
      const saveBusinessBtn = document.getElementById('save-business');
      const resetBusinessBtn = document.getElementById('reset-business');
      const businessStatus = document.getElementById('business-status');
      const businessSummary = document.getElementById('business-summary');
      const businessTitle = document.getElementById('business-title');

      const titleInput = document.getElementById('title');
      const bodyInput = document.getElementById('body');
      const imageFileInput = document.getElementById('image-file');
      const imageUploadStatus = document.getElementById('image-upload-status');
      const imageInput = document.getElementById('image-url');
      const imagePreview = document.getElementById('image-preview');
      const clickUrlInput = document.getElementById('click-url');
      const enrollmentLinkInput = document.getElementById('enrollment-link');
      const generateEnrollmentBtn = document.getElementById('generate-enrollment-link');
      const copyEnrollmentBtn = document.getElementById('copy-enrollment-link');
      const enrollmentHint = document.getElementById('enrollment-hint');
      copyEnrollmentBtn.disabled = true;

      const businessForm = {
        name: document.getElementById('business-name'),
        manager: document.getElementById('manager-name'),
        phone: document.getElementById('business-phone'),
        email: document.getElementById('business-email'),
        address: document.getElementById('business-address'),
        subscriberId: document.getElementById('business-subscriber-id'),
      };

      const callToggle = document.getElementById('toggle-call');
      const mapToggle = document.getElementById('toggle-map');
      const callNumberInput = document.getElementById('call-number');
      const destinationAddressInput = document.getElementById('destination-address');
      const landingPreviewLink = document.getElementById('landing-preview');
      const themeToggle = document.getElementById('theme-toggle');

      let businesses = [];
      let selectedBusinessId = null;

      function applyTheme(theme) {
        const nextTheme = theme || localStorage.getItem('notificator-theme') || 'dark';
        document.body.setAttribute('data-theme', nextTheme);
        localStorage.setItem('notificator-theme', nextTheme);
        themeToggle.textContent = nextTheme === 'dark' ? 'ðŸŒž Mode clair' : 'ðŸŒ™ Mode sombre';
      }

      function toggleTheme() {
        const current = document.body.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
      }

      function renderPreview() {
        const url = imageInput.value.trim();
        if (!url) {
          imagePreview.innerHTML = "PrÃ©visualisation de l'image";
          return;
        }
        imagePreview.innerHTML = `<img src="${url}" alt="PrÃ©visualisation" />`;
      }

      async function uploadLocalImage(file) {
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        imageUploadStatus.textContent = 'TÃ©lÃ©versement en cours...';
        imageUploadStatus.style.color = '#9ca3af';
        try {
          const response = await fetch('/api/uploads', {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            const message = error?.detail || "Impossible d'enregistrer l'image.";
            throw new Error(message);
          }
          const data = await response.json();
          imageInput.value = data.url;
          renderPreview();
          syncLandingLink();
          imageUploadStatus.textContent = 'Image hÃ©bergÃ©e localement et prÃªte Ã  Ãªtre envoyÃ©e.';
          imageUploadStatus.style.color = '#9ca3af';
        } catch (error) {
          console.error(error);
          imageUploadStatus.textContent = error.message;
          imageUploadStatus.style.color = '#f87171';
        }
      }

      function buildLandingLink() {
        const landingUrl = new URL(`${window.location.origin}/notification.html`);
        const imageUrl = imageInput.value.trim();
        const title = titleInput.value.trim();
        const body = bodyInput.value.trim();
        const callNumber = callNumberInput.value.trim();
        const destinationAddress = destinationAddressInput.value.trim();

        if (imageUrl) landingUrl.searchParams.set('image', imageUrl);
        if (title) landingUrl.searchParams.set('title', title);
        if (body) landingUrl.searchParams.set('body', body);
        if (callToggle.checked && callNumber) landingUrl.searchParams.set('call', callNumber);
        if (mapToggle.checked && destinationAddress) landingUrl.searchParams.set('address', destinationAddress);

        return landingUrl.toString();
      }

      function syncLandingLink() {
        const link = buildLandingLink();
        clickUrlInput.value = link;
        landingPreviewLink.href = link;
      }

      function renderBusinessSummary(business) {
        if (!business) {
          businessSummary.innerHTML = 'Choisissez un commerce pour afficher les informations existantes.';
          return;
        }
        businessSummary.innerHTML = `
          <p><strong>Nom :</strong> ${business.name}</p>
          <p><strong>GÃ©rant :</strong> ${business.manager_name || 'Non renseignÃ©'}</p>
          <p><strong>TÃ©lÃ©phone :</strong> ${business.phone || 'Non renseignÃ©'}</p>
          <p><strong>Email :</strong> ${business.email || 'Non renseignÃ©'}</p>
          <p><strong>Adresse :</strong> ${business.address || 'Non renseignÃ©e'}</p>
          <p><strong>ID abonnÃ© push :</strong> ${business.subscriber_id || 'Non associÃ©'}</p>
        `;
      }

      function buildEnrollmentLink(business) {
        const url = new URL(`${window.location.origin}/index.html`);
        url.searchParams.set('business_id', business.id);
        url.searchParams.set('business_name', business.name);
        return url.toString();
      }

      function renderEnrollmentLink(business) {
        if (!business) {
          enrollmentLinkInput.value = '';
          enrollmentHint.textContent = 'SÃ©lectionnez un commerce pour crÃ©er un lien de partage.';
          copyEnrollmentBtn.disabled = true;
          return;
        }

        enrollmentLinkInput.value = buildEnrollmentLink(business);
        enrollmentHint.textContent = "Partagez ce lien pour que le commerce s'inscrive aux notifications.";
        copyEnrollmentBtn.disabled = false;
      }

      function populateBusinessForm(business) {
        businessForm.name.value = business?.name || '';
        businessForm.manager.value = business?.manager_name || '';
        businessForm.phone.value = business?.phone || '';
        businessForm.email.value = business?.email || '';
        businessForm.address.value = business?.address || '';
        businessForm.subscriberId.value = business?.subscriber_id || '';
        callNumberInput.value = business?.phone || '';
        destinationAddressInput.value = business?.address || '';
        syncLandingLink();
      }

      function highlightSelection() {
        Array.from(businessList.children).forEach((li) => {
          li.classList.toggle('active', Number(li.dataset.id) === selectedBusinessId);
        });
      }

      function renderBusinessList(items) {
        businessList.innerHTML = '';
        items.forEach((business) => {
          const li = document.createElement('li');
          li.dataset.id = business.id;
          li.innerHTML = `
            <h3>${business.name}</h3>
            <div class="meta">${business.manager_name || 'GÃ©rant inconnu'}${business.phone ? ` â€¢ ${business.phone}` : ''}</div>
          `;
          li.addEventListener('click', () => selectBusiness(business.id));
          businessList.appendChild(li);
        });
        highlightSelection();
      }

      function filterBusinesses() {
        const query = search.value.toLowerCase();
        const filtered = businesses.filter((b) =>
          !query ||
          b.name.toLowerCase().includes(query) ||
          (b.manager_name && b.manager_name.toLowerCase().includes(query)) ||
          (b.phone && b.phone.toLowerCase().includes(query))
        );
        renderBusinessList(filtered);
      }

      function generateEnrollmentLink() {
        const business = businesses.find((b) => b.id === selectedBusinessId);
        if (!business) {
          enrollmentLinkInput.value = '';
          enrollmentHint.textContent = 'SÃ©lectionnez un commerce avant de gÃ©nÃ©rer un lien.';
          copyEnrollmentBtn.disabled = true;
          businessStatus.textContent = 'Aucun commerce sÃ©lectionnÃ© pour le lien.';
          businessStatus.style.color = '#f87171';
          return;
        }

        renderEnrollmentLink(business);
        businessStatus.textContent = 'Lien d\'enrÃ´lement gÃ©nÃ©rÃ© pour ce commerce';
        businessStatus.style.color = '#34d399';
      }

      async function copyEnrollmentLink() {
        if (!enrollmentLinkInput.value) {
          businessStatus.textContent = 'GÃ©nÃ©rez un lien avant de copier';
          businessStatus.style.color = '#f87171';
          return;
        }

        try {
          await navigator.clipboard.writeText(enrollmentLinkInput.value);
          businessStatus.textContent = 'Lien copiÃ© dans le presse-papiers';
          businessStatus.style.color = '#34d399';
        } catch (error) {
          console.error(error);
          businessStatus.textContent = 'Impossible de copier le lien';
          businessStatus.style.color = '#f87171';
        }
      }

      async function fetchBusinesses() {
        const response = await fetch('/api/businesses');
        if (!response.ok) return;
        businesses = await response.json();
        filterBusinesses();
        if (selectedBusinessId) {
          const existing = businesses.find((b) => b.id === selectedBusinessId);
          if (existing) {
            selectBusiness(existing.id, false);
          } else {
            resetBusinessForm();
          }
        }
      }

      function resetBusinessForm() {
        selectedBusinessId = null;
        businessTitle.textContent = 'Nouveau commerce';
        businessStatus.textContent = 'Aucun commerce sÃ©lectionnÃ©';
        businessStatus.style.color = '#9ca3af';
        populateBusinessForm(null);
        renderBusinessSummary(null);
        renderEnrollmentLink(null);
        highlightSelection();
      }

      function selectBusiness(id, updateList = true) {
        const business = businesses.find((b) => b.id === id);
        if (!business) {
          resetBusinessForm();
          return;
        }
        selectedBusinessId = business.id;
        businessTitle.textContent = `Fiche commerce Â· ${business.name}`;
        businessStatus.textContent = 'PrÃªt pour modification ou envoi';
        populateBusinessForm(business);
        renderBusinessSummary(business);
        renderEnrollmentLink(business);
        if (updateList) highlightSelection();
      }

      async function saveBusiness() {
        businessStatus.style.color = '#9ca3af';
        const payload = {
          name: businessForm.name.value.trim(),
          manager_name: businessForm.manager.value.trim() || null,
          phone: businessForm.phone.value.trim() || null,
          email: businessForm.email.value.trim() || null,
          address: businessForm.address.value.trim() || null,
          subscriber_id: businessForm.subscriberId.value ? Number(businessForm.subscriberId.value) : null,
        };

        if (!payload.name) {
          businessStatus.textContent = 'Le nom du commerce est requis';
          return;
        }

        const isNew = !selectedBusinessId;
        const url = isNew ? '/api/businesses' : `/api/businesses/${selectedBusinessId}`;
        const method = isNew ? 'POST' : 'PUT';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          businessStatus.textContent = 'Erreur lors de la sauvegarde du commerce';
          businessStatus.style.color = '#f87171';
          return;
        }

        const saved = await response.json();
        businessStatus.textContent = isNew ? 'Commerce ajoutÃ©' : 'Commerce mis Ã  jour';
        businessStatus.style.color = '#34d399';
        await fetchBusinesses();
        selectBusiness(saved.id);
      }

      async function fetchHistory() {
        const response = await fetch('/api/notifications');
        if (!response.ok) return;
        const items = await response.json();
        history.innerHTML = '';
        items.forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <h3>${item.title}</h3>
            <div class="meta">${new Date(item.created_at).toLocaleString()}</div>
            ${item.business ? `<div class="meta">Commerce : ${item.business.name}</div>` : ''}
            <div>${item.body || 'Pas de message'}</div>
            ${item.image_url ? `<div style="margin-top:8px;"><img src="${item.image_url}" alt="visuel" style="max-width:100%; border-radius:10px;" /></div>` : ''}
            ${item.click_url ? `<div class="meta">Lien : <a href="${item.click_url}" target="_blank" rel="noreferrer">${item.click_url}</a></div>` : ''}
          `;
          history.appendChild(li);
        });
      }

      async function sendNotification() {
        status.textContent = selectedBusinessId ? 'Envoi ciblÃ©...' : 'Envoi en cours...';
        status.style.color = '#9ca3af';

        syncLandingLink();

        const targetBusiness = businesses.find((b) => b.id === selectedBusinessId);
        if (selectedBusinessId && targetBusiness && !targetBusiness.subscriber_id) {
          status.textContent = 'Associez un abonnÃ© push Ã  ce commerce avant l\'envoi';
          status.style.color = '#f87171';
          return;
        }

        const payload = {
          title: titleInput.value,
          body: bodyInput.value || null,
          image_url: imageInput.value || null,
          click_url: clickUrlInput.value || null,
          business_id: selectedBusinessId,
        };

        const response = await fetch('/api/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          status.textContent = 'Erreur lors de la publication';
          status.style.color = '#f87171';
          return;
        }

        status.textContent = selectedBusinessId ? 'Notification envoyÃ©e Ã  ce commerce' : 'Notification envoyÃ©e';
        status.style.color = '#34d399';
        await fetchHistory();
      }

      addBusinessBtn.addEventListener('click', resetBusinessForm);
      saveBusinessBtn.addEventListener('click', saveBusiness);
      resetBusinessBtn.addEventListener('click', resetBusinessForm);
      document.getElementById('send').addEventListener('click', sendNotification);
      imageFileInput.addEventListener('change', async (event) => {
        const [file] = event.target.files;
        if (file) {
          await uploadLocalImage(file);
        } else {
          imageUploadStatus.textContent = "L'image sera hÃ©bergÃ©e localement sur le serveur.";
          imageUploadStatus.style.color = '#9ca3af';
        }
      });
      imageInput.addEventListener('input', () => {
        renderPreview();
        syncLandingLink();
      });
      titleInput.addEventListener('input', syncLandingLink);
      bodyInput.addEventListener('input', syncLandingLink);
      callNumberInput.addEventListener('input', syncLandingLink);
      destinationAddressInput.addEventListener('input', syncLandingLink);
      callToggle.addEventListener('change', syncLandingLink);
      mapToggle.addEventListener('change', syncLandingLink);
      themeToggle.addEventListener('click', toggleTheme);
      search.addEventListener('input', filterBusinesses);
      generateEnrollmentBtn.addEventListener('click', generateEnrollmentLink);
      copyEnrollmentBtn.addEventListener('click', copyEnrollmentLink);

      applyTheme();
      renderPreview();
      syncLandingLink();
      fetchHistory();
      fetchBusinesses();
    </script>
  </body>
</html>
